<!DOCTYPE HTML>
<html>
	<head>
		<title>LIVE FOR ALL. CREATED BY HƯNG NGUYỄN</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<link rel="stylesheet" href="assets/css/custom.css" />		
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css"/>
		<!--
		<link rel="stylesheet/less" type="text/css" href="//chat.hungnm144.com/client/themes/default/pfc.less" />
		<script src="//chat.hungnm144.com/client/lib/less-1.3.1.min.js" type="text/javascript"></script>
		
		<script>
			var less = { env: 'development' };
		</script>
		-->
	</head>
	<body>

		<!-- Header -->
		<section id="header">
			<header>
				<span class="image avatar"><a href="https://facebook.com/hungnm07" target="_blank" title="Author's Facebook"><img src="https://graph.facebook.com/100003285370544/picture?type=normal" alt="Author's Facebook: Hưng Nguyễn" /></a></span>
				<h1 id="logo"><a href="https://facebook.com/hungnm07" target="_blank" title="Author's Facebook">Hưng Nguyễn</a></h1>
				<p id="logs">Live for all</p>
			</header>				
			<nav id="nav">
				<ul>
					<li><a href="#home" class="active">Home</a></li>
					<li><a href="#about">About me</a></li>
				</ul>
			</nav>				
			<footer>
				<ul class="icons">
					<li><a href="https://facebook.com/hungnm07" target="_blank" title="Author's Facebook" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
					<li><a href="https://plus.google.com/+H%C6%B0ngNguy%E1%BB%85n-hungnm14487/" target="_blank" title="Author's Google Plus" class="icon fa-google-plus"><span class="label">Google+</span></a></li>
					<li><a href="https://twitter.com/hungnm07" target="_blank" title="Author's Twitter" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="https://instagram.com/hungnm07" target="_blank" title="Author's Instagram" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="mailto:hungnm144@live.com" title="Mail to Author" class="icon fa-envelope"><span class="label">Email</span></a></li>
				</ul>
			</footer>
		</section>

		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Main -->
			<div id="main">

				<!-- Home -->
					<section id="home">
						<div class="container">
							<header class="major">
								<h2>LIVE FOR ALL</h2>
								<p>Need help? Call (+84) 98 206 16 16</p>																				
							</header>
							<ul class="actions">
								<li><a id="play-broadcast" href="javascript:;" class="button special icon fa-play">PLAY NOW</a></li>
							</ul>								
						</div>
					</section>
					<section id="live">
						<div class="container" id="player">
							<p><video id="video-preview" width="854" height="480" controls crossorigin loop></video></p>							
							<blockquote id="show-info">
								<p>Share for friends</p>
								<ul id="room-info"></ul>										
							</blockquote>
							
						</div>
					</section>
					<section id="about">
						<div class="container">
							<h3>About me</h3>
							<blockquote>
								<ul class="feature-icons">
									<li class="fa-user"> Hung Nguyen</li>
									<li class="fa-home"> No.1, Phan Van Truong str.,<br /> Dich Vong Hau ward, Cau Giay Dist.,<br /> Hanoi, Vietnam</li>
									<li class="fa-phone"> (+84) 98 206 16 16</li>											
									<li class="fa-envelope"> hungnm144@live.com</li>											
								</ul>
								<ul class="icons">
									<li><a href="https://facebook.com/hungnm07" target="_blank" title="Author's Facebook" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
									<li><a href="https://plus.google.com/+H%C6%B0ngNguy%E1%BB%85n-hungnm14487/" target="_blank" title="Author's Google Plus" class="icon fa-google-plus"><span class="label">Google+</span></a></li>
									<li><a href="https://twitter.com/hungnm07" target="_blank" title="Author's Twitter" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
									<li><a href="https://instagram.com/hungnm07" target="_blank" title="Author's Instagram" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
									<li><a href="mailto:hungnm144@live.com" title="Mail to Author" class="icon fa-envelope"><span class="label">Email</span></a></li>
								</ul>
							</blockquote>
						</div>
					</section>							
			</div>

			<!-- Footer -->
			<section id="footer">
				<div class="container">
					<ul class="copyright">
						<li>&copy; Hưng Nguyễn. All rights reserved.</li>
					</ul>
				</div>
			</section>

		</div>

		<!-- Scripts -->
		<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>
		<script src="//code.jquery.com/jquery-migrate-1.4.1.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>

		<script src="assets/js/jquery.scrollzer.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/skel.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="assets/js/main.js"></script>
				
		<script>
			// skipping xirsys servers
			//window.getExternalIceServers = false;
		</script>
		<script src="//hungnm-live.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
		<script src="//hungnm-live.herokuapp.com/socket.io/socket.io.js"></script>	
		<!--<script src="dist/connect.js"></script>-->
		<script>
sChat.init('P8yogsvf5PjsGxQ7K', {
                ssl: true,
                welcomeMessage: 'Hi, how can I help you?',
                hostName: 'www.simplechat.support',
                labels: {
                    sendPlaceholder: 'Send the message...',
                    headerTitle: 'Welcome on my website!'
                }
            });		
			// Toast Notification config
			toastr.options = {
				"closeButton": true,
				"debug": false,
				"positionClass": "toast-top-left",
				"onclick": null,
				"showDuration": "5000",
				"hideDuration": "1000",
				"timeOut": "5000",
				"extendedTimeOut": "1000",
				"showEasing": "swing",
				"hideEasing": "linear",
				"showMethod": "fadeIn",
				"hideMethod": "fadeOut"
			};
			//CHAT.init();			
			var CONNECT = function() {
				var videoPreview = document.getElementById('video-preview'),
				playButton = document.getElementById('play-broadcast'),
				broadcastDefaultId = 'hungnm07',
				// recording is disabled because it is resulting for browser-crash
				// if you enable below line, please also uncomment above "RecordRTC.js"
				enableRecordings = false,
				allRecordedBlobs = [],
				// Handle Connector
				handleConnector = function(){					

					var connection = new RTCMultiConnection(null, {
						useDefaultDevices: true // if we don't need to force selection of specific devices
					});

					// Quality broadcast			
					var BandwidthHandler = connection.BandwidthHandler;
					connection.bandwidth = {
						audio: 128,
						video: 2048
						//screen: 300
					};
					connection.processSdp = function(sdp) {
						sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, connection.bandwidth, !!connection.session.screen);
						sdp = BandwidthHandler.setVideoBitrates(sdp, {
							min: connection.bandwidth.video,
							max: connection.bandwidth.video
						});

						sdp = BandwidthHandler.setOpusAttributes(sdp);

						sdp = BandwidthHandler.setOpusAttributes(sdp, {
							'stereo': 1,
							//'sprop-stereo': 1,
							'maxaveragebitrate': connection.bandwidth.audio * 1000 * 8,
							'maxplaybackrate': connection.bandwidth.audio * 1000 * 8,
							//'cbr': 1,
							//'useinbandfec': 1,
							// 'usedtx': 1,
							'maxptime': 3
						});

						return sdp;
					};
										
					// its mandatory in v3
					connection.enableScalableBroadcast = true;

					// each relaying-user should serve only 1 users
					connection.maxRelayLimitPerUser = 1;

					// we don't need to keep room-opened
					// scalable-broadcast.js will handle stuff itself.
					connection.autoCloseEntireSession = true;

					// by default, socket.io server is assumed to be deployed on your own URL
					//connection.socketURL = '/';

					// comment-out below line if you do not have your own socket.io server
					connection.socketURL = 'https://hungnm-live.herokuapp.com:443/';

					connection.socketMessageEvent = 'hungnm07-broadcast';

					// document.getElementById('broadcast-id').value = connection.userid;
					// ......................................................
					// ..................Custom Messages.....................
					// ......................................................

					// this line must be defined earlier before "getSocket"
					// or before open/join/openOrJoin
					// connection.socketCustomEvent = 'custom-socket-event';

					// to make above line highly secure;
					// so that only users in the same channel can receive/send custom messages!
					connection.socketCustomEvent = 'hungnm07-message';//connection.channel;
					// user need to connect server, so that others can reach him.
					connection.connectSocket(function(socket) {
						socket.on('logs', function(log) {
							document.getElementById('logs').innerHTML = log.replace(/</g, '----').replace(/>/g, '___').replace(/----/g, '(<span style="color:red;">').replace(/___/g, '</span>)');
						});
						
						// listen custom messages from server
						socket.on(connection.socketCustomEvent, function(message) {
							//alert(message.sender + ' shared custom message:\n\n' + message.customMessage);
							toastr["info"](message.customMessage, message.sender + " thông báo");
						});
						
						// this event is emitted when a broadcast is already created.
						socket.on('join-broadcaster', function(hintsToJoinBroadcast) {
							console.log('join-broadcaster', hintsToJoinBroadcast);

							connection.session = hintsToJoinBroadcast.typeOfStreams;
							connection.sdpConstraints.mandatory = {
								OfferToReceiveVideo: !!connection.session.video,
								OfferToReceiveAudio: !!connection.session.audio
							};
							connection.broadcastId = hintsToJoinBroadcast.broadcastId;
							connection.join(hintsToJoinBroadcast.userid);
							
						});

						socket.on('rejoin-broadcast', function(broadcastId) {
							console.log('rejoin-broadcast', broadcastId);

							connection.attachStreams = [];
							socket.emit('check-broadcast-presence', broadcastId, function(isBroadcastExists) {
								if(!isBroadcastExists) {
									// the first person (i.e. real-broadcaster) MUST set his user-id
									toastr["error"]("Kênh này chưa phát sóng", "Báo lỗi");
									return false;
									//connection.userid = broadcastId;
								}

								socket.emit('join-broadcast', {
									broadcastId: broadcastId,
									userid: connection.userid,
									typeOfStreams: connection.session
								});
							});
						});

						socket.on('broadcast-stopped', function(broadcastId) {
							// alert('Broadcast has been stopped.');
							// location.reload();
							console.error('broadcast-stopped', broadcastId);
							//alert('This broadcast has been stopped.');
							toastr["error"]("Kênh này đã dừng phát", "Báo lỗi");
						});

						// this event is emitted when a broadcast is absent.
						/*
						socket.on('start-broadcasting', function(typeOfStreams) {
							console.log('start-broadcasting', typeOfStreams);

							// host i.e. sender should always use this!
							connection.sdpConstraints.mandatory = {
								OfferToReceiveVideo: false,
								OfferToReceiveAudio: false
							};
							connection.session = typeOfStreams;

							// "open" method here will capture media-stream
							// we can skip this function always; it is totally optional here.
							// we can use "connection.getUserMediaHandler" instead
							connection.open(connection.userid, function() {
								showRoomURL(connection.sessionid);
							});
						});
						*/
					});

					window.onbeforeunload = function() {
						// Firefox is ugly.
						playButton.disabled = false;
					};

					// On Stream action
					connection.onstream = function(event) {
						if(connection.isInitiator && event.type !== 'local') {
							return;
						}

						if(event.mediaElement) {
							event.mediaElement.pause();
							delete event.mediaElement;
						}

						connection.isUpperUserLeft = false;
						videoPreview.src = URL.createObjectURL(event.stream);
						videoPreview.play();

						videoPreview.userid = event.userid;

						if(event.type === 'local') {
							videoPreview.muted = true;
						}

						if (connection.isInitiator == false && event.type === 'remote') {
							// he is merely relaying the media
							connection.dontCaptureUserMedia = true;
							connection.attachStreams = [event.stream];
							connection.sdpConstraints.mandatory = {
								OfferToReceiveAudio: false,
								OfferToReceiveVideo: false
							};

							var socket = connection.getSocket();
							socket.emit('can-relay-broadcast');

							if(connection.DetectRTC.browser.name === 'Chrome') {
								connection.getAllParticipants().forEach(function(p) {
									if(p + '' != event.userid + '') {
										var peer = connection.peers[p].peer;
										peer.getLocalStreams().forEach(function(localStream) {
											peer.removeStream(localStream);
										});
										peer.addStream(event.stream);
										connection.dontAttachStream = true;
										connection.renegotiate(p);
										connection.dontAttachStream = false;
									}
								});
							}

							if(connection.DetectRTC.browser.name === 'Firefox') {
								// Firefox is NOT supporting removeStream method
								// that's why using alternative hack.
								// NOTE: Firefox seems unable to replace-tracks of the remote-media-stream
								// need to ask all deeper nodes to rejoin
								connection.getAllParticipants().forEach(function(p) {
									if(p + '' != event.userid + '') {
										connection.replaceTrack(event.stream, p);
									}
								});
							}

							// Firefox seems UN_ABLE to record remote MediaStream
							// WebAudio solution merely records audio
							// so recording is skipped for Firefox.
							if(connection.DetectRTC.browser.name === 'Chrome') {
								CONNECT.repeatedlyRecordStream(connection, event.stream);
							}
						}
					};
					
					// On Stream ended action
					connection.onstreamended = function(e) {
						//e.mediaElement.parentNode.removeChild(e.mediaElement);
						//console.error('stream-ended', broadcastId);
						toastr["warning"]("Bạn đã ngừng xem kênh này", "Thông báo");
						return false;
					};

					// On leave stream action
					connection.onleave = function(event) {
						if(event.userid !== videoPreview.userid) return;

						var socket = connection.getSocket();
						socket.emit('can-not-relay-broadcast');

						connection.isUpperUserLeft = true;

						if(allRecordedBlobs.length) {
							// playing lats recorded blob
							var lastBlob = allRecordedBlobs[allRecordedBlobs.length - 1];
							videoPreview.src = URL.createObjectURL(lastBlob);
							videoPreview.play();
							allRecordedBlobs = [];
						}
						else if(connection.currentRecorder) {
							var recorder = connection.currentRecorder;
							connection.currentRecorder = null;
							recorder.stopRecording(function() {
								if(!connection.isUpperUserLeft) return;

								videoPreview.src = URL.createObjectURL(recorder.blob);
								videoPreview.play();
							});
						}

						if(connection.currentRecorder) {
							connection.currentRecorder.stopRecording();
							connection.currentRecorder = null;
						}
					};

					// ask node.js server to look for a broadcast
					// if broadcast is available, simply join it. i.e. "join-broadcaster" event should be emitted.
					// if broadcast is absent, simply create it. i.e. "start-broadcasting" event should be fired.
					CONNECT.playStream(connection);
					
				}
				return {
					init: function(){
						handleConnector();						
					},
					
					repeatedlyRecordStream: function (connection, stream) {
						if(!enableRecordings) {
							return;
						}

						connection.currentRecorder = RecordRTC(stream, {
							type: 'video'
						});

						connection.currentRecorder.startRecording();

						setTimeout(function() {
							if(connection.isUpperUserLeft || !connection.currentRecorder) {
								return;
							}

							connection.currentRecorder.stopRecording(function() {
								allRecordedBlobs.push(connection.currentRecorder.blob);

								if(connection.isUpperUserLeft) {
									return;
								}

								connection.currentRecorder = null;
								CONNECT.repeatedlyRecordStream(connection, stream);
							});
						}, 30 * 1000); // 30-seconds
					},
				
					// PLAY STREAM
					playStream: function(connection) {
						playButton.onclick = function() {
							var broadcastId = broadcastDefaultId;
							if (broadcastId.replace(/^\s+|\s+$/g, '').length <= 0) {
								//alert('Please enter broadcast-id');
								toastr["error"]("Không tìm thấy mã kênh", "Báo lỗi");  
								//document.getElementById('broadcast-id').focus();
								return;
							}
							// Show share info
							CONNECT.showRoomURL();
							
							// Remove button play
							//playButton.style.display = 'none';

							connection.session = {
								audio: true,
								video: true,
								oneway: true
							};

							var socket = connection.getSocket();

							socket.emit('check-broadcast-presence', broadcastId, function(isBroadcastExists) {
								if(!isBroadcastExists) {
									// the first person (i.e. real-broadcaster) MUST set his user-id
									toastr["error"]("Kênh này chưa phát sóng", "Báo lỗi");
									return false;
									//connection.userid = broadcastId;
								}

								console.log('check-broadcast-presence', broadcastId, isBroadcastExists);

								socket.emit('join-broadcast', {
									broadcastId: broadcastId,
									userid: connection.userid,
									typeOfStreams: connection.session
								});
								
							});
							// Open Video Preview
							/*
							$.fancybox({
								width: videoPreview.offsetHeight,
								height: videoPreview.offsetHeight,
								padding: 0,
								margin:0,
								href : '#video-preview'
							});
							*/
							document.getElementById('player').style.display = 'block';
						};
					},

					// ......................................................
					// ......................Handling broadcast-id................
					// ......................................................

					showRoomURL: function () {												
						var html = '<li>' + CONNECT.getBaseUrl() + '</li>';
						var roomURLsDiv = document.getElementById('room-info');						
						roomURLsDiv.innerHTML = html;
						document.getElementById('show-info').style.display = 'block';						
					},

					getBaseUrl: function() {
						return window.location.href.match(/^.*\//);
					}
					
				};
			}();
            
			CONNECT.init();
        </script>

		<!--
		<script src="//chat.hungnm144.com/client/pfc.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-init.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-core.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-auth.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-commands.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-cmd_join.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-cmd_op.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-cmd_kick.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-cmd_ban.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-channels.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-users.js" type="text/javascript"></script>
		<script src="//chat.hungnm144.com/client/pfc-utils.js" type="text/javascript"></script>
		<script>
			var less = { env: 'development' };
			$('#chat-hook').chat({ serverUrl: '//chat.hungnm144.com/server' });
			// Toast Notification config
			toastr.options = {
				"closeButton": true,
				"debug": false,
				"positionClass": "toast-top-left",
				"onclick": null,
				"showDuration": "1000",
				"hideDuration": "1000",
				"timeOut": "5000",
				"extendedTimeOut": "1000",
				"showEasing": "swing",
				"hideEasing": "linear",
				"showMethod": "fadeIn",
				"hideMethod": "fadeOut"
			};
		</script>
		-->
		<script>
			var fbName = '<?php echo isset($_SESSION['FULLNAME'])? $_SESSION['FULLNAME']:'';?>';
			var fbId = '<?php echo isset($_SESSION['FBID'])? $_SESSION['FBID']:'';?>';
			var fbEmail = '<?php echo isset($_SESSION['EMAIL'])? $_SESSION['EMAIL']:'';?>';
			<?php if (isset($_SESSION['FBID']) && $_SESSION['FBID']): ?>
			$(function() {
				//pfc.modalbox.submit();
			});
			<?php endif; ?>
		</script>
	</body>
</html>